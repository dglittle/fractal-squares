<html>
<head>
<meta charset='utf-8'>
<title>squares</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 0px;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="http://dglittle.github.io/gl519/random.js"></script>
<script src="http://dglittle.github.io/gl519/aes.js"></script>
<script src="utils.js"></script>

<script>

$(function () {
    var colorSeed = null
    var maxDepth = 10

    var squares = [
        [
            [Math.cos(tau/6)/3, -Math.sin(tau/6)/3],
            [Math.cos(tau/12)/3, Math.sin(tau/12)/3],
            [5/12, 1/2 - Math.sin(tau/6)/6]
        ],
        [
            [Math.cos(tau/6)/3, Math.sin(tau/6)/3],
            [-Math.cos(tau/12)/3, Math.sin(tau/12)/3],
            [7/12, 1/2 - Math.sin(tau/6)/6]
        ],
        [[1/3, 0], [0, 1/3], [1/6, 1/2]],
        [[1/3, 0], [0, 1/3], [5/6, 1/2]]
    ]

    function transform(pos, m) {
        pos = pos.slice(0)
        pos.push(1)
        return matmul([pos], m)[0]
    }

    function inv2x2(m) {
        var s = 1/(m[0][0]*m[1][1] - m[0][1]*m[1][0])
        return [[m[1][1]*s, -m[0][1]*s], [-m[1][0]*s, m[0][0]*s]]
    }

    function transformInv(pos, m) {
        pos = sub(pos, m[2])
        return matmul([pos], inv2x2(m))[0]
    }

    function pickSquare(pos) {
        function distToCenter(s) {
            var p = transformInv(pos, s)
            return dist(p)
        }
        function distToEdge(s) {
            var p = add(transformInv(pos, s), [.5, .5])
            if (p[0] < 0 && p[1] < 0) return dist(p, [0, 0])
            if (p[0] < 0 && p[1] > 1) return dist(p, [0, 1])
            if (p[0] > 1 && p[1] > 1) return dist(p, [1, 1])
            if (p[0] > 1 && p[1] < 0) return dist(p, [1, 0])
            if (p[0] < 0) return -p[0]
            if (p[0] > 1) return p[0] - 1
            if (p[1] < 0) return -p[1]
            if (p[1] > 1) return p[1] - 1
            return Math.min(p[0], p[1], 1 - p[0], 1 - p[1])
        }
        _.each(squares, function (s) {
            var scale = dist(s[0])
            s.distToCenter = distToCenter(s) * scale
            s.distToEdge = distToEdge(s) * scale
        })
        var closestCenter = _.min(squares, function (s) { return s.distToCenter })
        var closestEdge = _.min(squares, function (s) { return s.distToEdge })
        return closestCenter.distToCenter < 2.5*closestEdge.distToEdge ?
            { part : 'center', square : closestCenter } :
            { part : 'edge', square : closestEdge }
    }

    function triangleFractalize(c) {
        var size = c.attr('width')
        var prevC = null
        if (colorSeed) {
            Math.randomSeed(colorSeed)
            color = _.shuffle([1, .5, 0])
            function pickColor() {
                var c = mul(color, [Math.random(), Math.random(), Math.random()])
                return 'rgba(' + _.map(c, function (c) { return Math.floor(c * 256) }).join(',') + ',.1)'
            }
            var colors = _.map(_.range(maxDepth), pickColor)
        }
        for (var depth = 0; depth < maxDepth; depth++) {
            var c2 = $('<canvas/>').attr({ width : size, height : size })
            var g = c2[0].getContext('2d')

            if (colorSeed)
                g.fillStyle = colors.pop()
            else
                g.fillStyle = 'rgba(0,0,0,.1)'
            g.fillRect(0, 0, size, size)

            if (prevC) {
                _.each(squares, function (s) {
                    g.setTransform(s[0][0], s[0][1], s[1][0], s[1][1], s[2][0]*size, s[2][1]*size)
                    g.drawImage(prevC[0], -size/2, -size/2)
                })
            }
            prevC = c2
        }
        if (colorSeed) Math.randomSeed()

        var g = c[0].getContext('2d')
        g.fillStyle = 'white'
        g.fillRect(0, 0, size, size)
        g.drawImage(prevC[0], 0, 0)
    }

    var main = $('<div/>')
    $('body').append(main)

    function update() {
        var size = _.min(getWindowSize())
        var c = $('<canvas style="float:left"/>').attr({ width : size, height : size })
        var g = c[0].getContext('2d')

        function render() {
            triangleFractalize(c)
        }
        render()

        var drag = null
        grabMouseRelative(c, function (pos) {
            drag = pickSquare(mul(pos, 1/size))
            drag.start = pos
        }, function (diff, pos) {
            maxDepth = 10
            if (drag.part == 'center') {
                drag.square[2] = add(drag.square[2], mul(diff, 1/size))
                render()
            } else {
                var lastPos = sub(pos, diff)
                var p = sub(lastPos, mul(drag.square[2], size))
                var m = [p, [-p[1], p[0]]]

                p = sub(pos, mul(drag.square[2], size))
                p = matmul([p], inv2x2(m))[0]

                m = [p, [-p[1], p[0]]]
                m = matmul(drag.square.slice(0, 2), m)
                drag.square[0] = m[0]
                drag.square[1] = m[1]

                render()
            }
        })

        main.empty().append(c).append(drawForkMe())

        function drawButton(label, cb) {
            var leaning = Math.random() > 0.5
            function randomMatrix() {
                var scale = _.lerp(0, .9, 1, 1.1, Math.random())
                var angle = _.lerp(0, 1/24, 1, 2/24, Math.random()) * (leaning ? 1 : -1)
                var cos = Math.cos(angle) * scale
                var sin = Math.sin(angle) * scale
                return 'matrix(' + cos + ',' + sin + ',' + -sin + ',' + cos + ',0,0)'
            }
            return $('<div style="margin:' + size/6/7 + 'px;background:rgba(0,0,0,.1);width:' + size/6 + 'px;height:' + size/6 + 'px;-webkit-transform:' + randomMatrix() + ';-webkit-transition:-webkit-transform .7s cubic-bezier(.3,-10,.6,10);transform:' + randomMatrix() + ';transition:transform .7s cubic-bezier(.3,-10,.6,10)"/>').append(center(label)).click(function () {
                leaning = !leaning
                $(this).myCss('-webkit-transform:' + randomMatrix() + ';transform:' + randomMatrix())
                cb()
            })
        }

        var buttons = [
            drawButton($('<div/>').html('new<br/>square'), function () {
                var scale = _.lerp(0, .3, 1, .6, Math.random())
                var angle = _.lerp(0, -3/24, 1, 3/24, Math.random())
                var cos = Math.cos(angle) * scale
                var sin = Math.sin(angle) * scale
                var x = _.lerp(0, .2, 1, .8, Math.random())
                var y = _.lerp(0, .2, 1, .8, Math.random())
                squares.push([[cos, sin], [-sin, cos], [x, y]])
                render()
            }),
            drawButton($('<div/>').html('recolor'), function () {
                colorSeed = 'seed' + Math.random()
                render()
            }),
            drawButton($('<div/>').html('b &amp; w'), function () {
                colorSeed = null
                render()
            }),
            drawButton($('<div/>').html('share'), function () {
                postCanvasToFacebook(c)
            }),
            drawButton($('<div/>').html('see<br/>high<br/>depth'), function () {
                maxDepth = 200
                render()
            })
        ]
        var d = $('<div style="float:left">').append(buttons[0])
        main.append(d)
        if (buttons[0].offset().top > size/2) {
            var rest = buttons.slice(1)
            _.each(rest, function (b) { b.myCss('float:left') })
            main.myAppend(rest)
        } else {
            var rest = buttons.slice(1)
            d.myAppend(rest)
        }
    }
    update()
    $(window).resize(update)

    initFacebook('303587479797210')
})

function initFacebook(appId) {
    var callbacks = []

    $('body').prepend($('<div id="fb-root"></div>'))
    $.ajaxSetup({ cache: true });
    $.getScript('//connect.facebook.net/en_UK/all.js', function(){
        FB.init({
            appId: appId,
        });     
        $('#loginbutton,#feedbutton').removeAttr('disabled');
        // FB.getLoginStatus(updateStatusCallback);

        _.each(callbacks, function (f) { f() })
        callbacks = null
    });

    waitForFacebook = function (func) {
        if (!callbacks) func()
        else callbacks.push(func)
    }
}

// from: http://stackoverflow.com/a/5303242/945521
if (XMLHttpRequest.prototype.sendAsBinary === undefined) {
    XMLHttpRequest.prototype.sendAsBinary = function(string) {
        var bytes = Array.prototype.map.call(string, function(c) {
            return c.charCodeAt(0) & 0xff;
        });
        this.send(new Uint8Array(bytes).buffer);
    };
}

// adapted from http://www.heroesgenerator.com/
function postCanvasToFacebook(c) {
    function postImageToFacebook(authToken, filename, mimeType, imageData, message)
    {
        var boundary = '----ThisIsTheBoundary1234567890'
        var formData = '--' + boundary + '\r\n'
        formData += 'Content-Disposition: form-data; name="source"; filename="' + filename + '"\r\n'
        formData += 'Content-Type: ' + mimeType + '\r\n\r\n'
        for (var i = 0; i < imageData.length; i++) {
            formData += String.fromCharCode(imageData[i] & 0xff)
        }
        formData += '\r\n'
        formData += '--' + boundary + '\r\n'
        formData += 'Content-Disposition: form-data; name="message"\r\n\r\n'
        formData += message + '\r\n'
        formData += '--' + boundary + '--\r\n'
        
        var xhr = new XMLHttpRequest()
        xhr.open('POST', 'https://graph.facebook.com/me/photos?access_token=' + authToken, true)
        xhr.onload = xhr.onerror = function() {
            console.log(xhr.responseText)
        }
        xhr.setRequestHeader("Content-Type", "multipart/form-data; boundary=" + boundary)
        xhr.sendAsBinary(formData)
    }

    function helper() {
        postImageToFacebook(FB.getAuthResponse()['accessToken'], 'testing1', 'image/png', data, location.href)
    }

    var data = c.toDataURL("image/png")
    data = data.slice(data.indexOf(',') + 1)
    data = Base64.decode(data)
    waitForFacebook(function () {
        FB.getLoginStatus(function(res) {
            if (res.status == 'connected') {
                helper()
            } else {
                FB.login(helper, { scope : 'publish_stream' })
            }
        })
    })
}

</script>

</body>
</html>
