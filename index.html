<html>
<head>
<meta charset='utf-8'>
<title>squares</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 0px;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="utils.js"></script>
<script>

$(function () {

    var squares = [
        [
            [Math.cos(tau/6)/3, -Math.sin(tau/6)/3],
            [Math.cos(tau/12)/3, Math.sin(tau/12)/3],
            [1/3 - Math.sin(tau/6)/6, 1/2 - Math.cos(tau/6)/6]
        ],
        [
            [Math.cos(tau/6)/3, Math.sin(tau/6)/3],
            [-Math.cos(tau/12)/3, Math.sin(tau/12)/3],
            [1/2 + Math.sin(tau/6)/6, 1/2 - Math.cos(tau/6)/6 - Math.sin(tau/6)/3]
        ],
        [[1/3, 0], [0, 1/3], [0, 1/3]],
        [[1/3, 0], [0, 1/3], [2/3, 1/3]]
    ]

    function transform(pos, m) {
        pos = pos.slice(0)
        pos.push(1)
        return matmul([pos], m)[0]
    }

    function transformInv(pos, m) {
        pos = sub(pos, m[2])
        var s = 1/(m[0][0]*m[1][1] - m[0][1]*m[1][0])
        return matmul([pos], [[m[1][1]*s, -m[0][1]*s], [-m[1][0]*s, m[0][0]*s]])[0]
    }

    function pickSquare(pos) {
        return _.min(squares, function (s) {
            var p = transformInv(pos, s)
            return dist(p, [.5, .5])
        })
    }

    function triangleFractalize(c) {
        var size = c.attr('width')
        var prevC = null
        for (var depth = 0; depth < 8; depth++) {
            var c2 = $('<canvas/>').attr({ width : size, height : size })
            var g = c2[0].getContext('2d')

            g.fillStyle = 'rgba(' + _.map(_.range(3), function () { return Math.floor(Math.random() * 256) }).join(',') + ', .3)'
            g.fillStyle = 'rgba(0,0,0,.1)'
            g.fillRect(0, 0, size, size)

            if (prevC) {
                _.each(squares, function (s) {
                    g.setTransform(s[0][0], s[0][1], s[1][0], s[1][1], s[2][0]*size, s[2][1]*size)
                    g.drawImage(prevC[0], 0, 0)

                })
            }
            prevC = c2
        }

        var g = c[0].getContext('2d')
        g.fillStyle = 'white'
        g.fillRect(0, 0, size, size)
        g.drawImage(prevC[0], 0, 0)
    }

    function update() {
        var size = _.min(getWindowSize())
        var c = $('<canvas/>').attr({ width : size, height : size })
        var g = c[0].getContext('2d')

        function render() {
            triangleFractalize(c)
        }
        render()

        var dragSquare = null
        grabMouseRelative(c, function (pos) {
            dragSquare = pickSquare(mul(pos, 1/size))
        }, function (diff) {
            dragSquare[2] = add(dragSquare[2], mul(diff, 1/size))
            render()
        })

        $('body').empty().append(c).append(drawForkMe())
    }
    update()
    $(window).resize(update)
})

</script>

</body>
</html>
